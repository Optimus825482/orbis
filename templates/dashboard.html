{% extends "layout.html" %} {% block title %}ORBIS - Doğum ve Transit Girişi{%
endblock %} {% block head %} {{ super() }}
<style>
  .glass-panel {
    background: rgba(15, 23, 42, 0.6);
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
    border: 1px solid rgba(255, 255, 255, 0.05);
  }
  input[type="date"]::-webkit-calendar-picker-indicator,
  input[type="time"]::-webkit-calendar-picker-indicator {
    filter: invert(1);
    opacity: 0.6;
    cursor: pointer;
  }
  .location-suggestions {
    position: absolute;
    z-index: 50;
    background-color: #1e293b;
    width: 100%;
    margin-top: 0.25rem;
    border-radius: 1rem;
    box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.5);
    border: 1px solid rgba(255, 255, 255, 0.1);
    max-height: 15rem;
    overflow-y: auto;
  }
  .location-suggestion-item {
    padding: 0.75rem 1rem;
    cursor: pointer;
    color: #e2e8f0;
    font-size: 0.875rem;
    transition: background-color 0.2s;
  }
  .location-suggestion-item:hover {
    background-color: rgba(255, 255, 255, 0.05);
  }
</style>
{% endblock %} {% block content %}
<div
  class="relative min-h-screen flex flex-col items-center justify-center px-6 py-10 max-w-lg mx-auto w-full"
>
  <!-- Geometric Overlay Decor -->
  <div
    class="absolute top-[10%] left-0 w-full flex justify-center opacity-20 pointer-events-none"
  >
    <div
      class="w-64 h-64 border border-white/20 rounded-full animate-spin-slow"
    ></div>
  </div>

  <!-- Page Header -->
  <header class="text-center mb-8 w-full animate-fade-in relative z-10">
    <h1
      class="text-5xl font-display font-bold tracking-[0.2em] text-white drop-shadow-[0_0_15px_rgba(255,255,255,0.3)] mb-3"
    >
      ORBIS
    </h1>
    <div
      class="h-[1px] w-24 bg-gradient-to-r from-transparent via-white/40 to-transparent mx-auto mb-4"
    ></div>
    <!-- ORBIS Avatar -->
    <div class="flex flex-col items-center mb-4">
      <div
        class="w-20 h-20 rounded-full border-2 border-primary/30 p-1 mb-2 animate-breathe"
      >
        <div class="w-full h-full rounded-full overflow-hidden">
          <img
            src="{{ url_for('static', filename='ai-avatar-R.png') }}"
            alt="ORBIS AI"
            class="w-full h-full object-cover"
          />
        </div>
      </div>
      <p
        class="text-[10px] uppercase tracking-[0.4em] text-slate-400 font-bold"
      >
        Kaderin Geometrisi
      </p>
    </div>
  </header>

  <!-- Entry Form Panel -->
  <div
    class="w-full glass-panel rounded-3xl relative p-8 backdrop-blur-2xl z-10 shadow-3xl shadow-black/50 overflow-hidden"
  >
    <!-- Corner Decors -->
    <div
      class="absolute top-0 left-0 w-8 h-8 border-t border-l border-white/20"
    ></div>
    <div
      class="absolute top-0 right-0 w-8 h-8 border-t border-r border-white/20"
    ></div>
    <div
      class="absolute bottom-0 left-0 w-8 h-8 border-b border-l border-white/20"
    ></div>
    <div
      class="absolute bottom-0 right-0 w-8 h-8 border-b border-r border-white/20"
    ></div>

    <form
      id="orbisForm"
      method="POST"
      action="{{ url_for('main.show_results') }}"
      class="space-y-8"
    >
      <input type="hidden" id="latitude" name="latitude" />
      <input type="hidden" id="longitude" name="longitude" />
      <input type="hidden" id="transit_latitude" name="transit_latitude" />
      <input type="hidden" id="transit_longitude" name="transit_longitude" />

      <!-- Section: Birth Data -->
      <div class="space-y-6">
        <div class="flex items-center gap-3 mb-2">
          <span
            class="w-2 h-2 bg-primary rounded-full shadow-[0_0_8px_rgba(91,43,238,0.8)]"
          ></span>
          <h2
            class="text-sm font-display font-bold text-white uppercase tracking-[0.2em]"
          >
            Doğum Bilgileri
          </h2>
        </div>

        <div class="group relative">
          <label
            class="block text-[10px] uppercase tracking-[0.2em] text-slate-500 mb-2 font-bold ml-1"
            >İsim</label
          >
          <input
            type="text"
            name="name"
            id="name"
            required
            placeholder="İsminiz"
            class="w-full px-5 py-4 bg-white/5 border border-white/10 text-sm text-white focus:ring-1 focus:ring-primary/50 focus:border-primary/50 transition-all font-display rounded-2xl outline-none hover:bg-white/10"
          />
        </div>

        <div class="grid grid-cols-2 gap-4">
          <div class="group relative">
            <label
              class="block text-[10px] uppercase tracking-[0.2em] text-slate-500 mb-2 font-bold ml-1"
              >Doğum Tarihi</label
            >
            <input
              type="date"
              name="birth_date"
              id="birth_date"
              required
              class="w-full px-5 py-4 bg-white/5 border border-white/10 text-sm text-white focus:ring-1 focus:ring-primary/50 focus:border-primary/50 transition-all rounded-2xl outline-none hover:bg-white/10"
            />
          </div>
          <div class="group relative">
            <label
              class="block text-[10px] uppercase tracking-[0.2em] text-slate-500 mb-2 font-bold ml-1"
              >Doğum Saati</label
            >
            <input
              type="time"
              name="birth_time"
              id="birth_time"
              required
              class="w-full px-5 py-4 bg-white/5 border border-white/10 text-sm text-white focus:ring-1 focus:ring-primary/50 focus:border-primary/50 transition-all rounded-2xl outline-none hover:bg-white/10"
            />
          </div>
        </div>

        <div class="group relative">
          <label
            class="block text-[10px] uppercase tracking-[0.2em] text-slate-500 mb-2 font-bold ml-1"
            >Doğum Yeri</label
          >
          <div class="relative">
            <input
              type="text"
              id="suggestionInput"
              name="birth_place_suggestion"
              autocomplete="off"
              placeholder="Şehir Ara..."
              class="w-full px-5 py-4 bg-white/5 border border-white/10 text-sm text-white focus:ring-1 focus:ring-primary/50 focus:border-primary/50 transition-all rounded-2xl outline-none hover:bg-white/10 pl-12"
            />
            <span
              class="material-icons-round absolute left-4 top-1/2 -translate-y-1/2 text-slate-500 text-lg"
              >place</span
            >
            <div
              id="suggestionResults"
              class="location-suggestions hidden"
            ></div>
          </div>
        </div>
      </div>

      <!-- Divider Decor -->
      <div class="relative py-4 flex items-center justify-center">
        <div class="w-full h-[1px] bg-white/5"></div>
        <div
          class="absolute w-8 h-8 rounded-full border border-white/10 bg-background-dark flex items-center justify-center group pointer-events-none"
        >
          <span class="material-icons-round text-slate-600 text-xs"
            >keyboard_double_arrow_down</span
          >
        </div>
      </div>

      <!-- Section: Transit Data -->
      <div class="space-y-6">
        <div class="flex items-center gap-3 mb-2">
          <span
            class="w-2 h-2 border border-accent rounded-full shadow-[0_0_8px_rgba(56,189,248,0.5)]"
          ></span>
          <h2
            class="text-sm font-display font-bold text-white uppercase tracking-[0.2em]"
          >
            Transit Analizi
          </h2>
        </div>

        <div class="grid grid-cols-2 gap-4">
          <div class="group relative">
            <label
              class="block text-[10px] uppercase tracking-[0.2em] text-slate-500 mb-2 font-bold ml-1"
              >Transit Tarihi</label
            >
            <input
              type="date"
              id="transit_date"
              name="transit_date"
              class="w-full px-5 py-4 bg-white/5 border border-white/10 text-sm text-white focus:ring-1 focus:ring-accent/50 focus:border-accent/50 transition-all rounded-2xl outline-none hover:bg-white/10"
            />
          </div>
          <div class="group relative">
            <label
              class="block text-[10px] uppercase tracking-[0.2em] text-slate-500 mb-2 font-bold ml-1"
              >Transit Saati</label
            >
            <input
              type="time"
              id="transit_time"
              name="transit_time"
              class="w-full px-5 py-4 bg-white/5 border border-white/10 text-sm text-white focus:ring-1 focus:ring-accent/50 focus:border-accent/50 transition-all rounded-2xl outline-none hover:bg-white/10"
            />
          </div>
        </div>

        <div class="group relative">
          <label
            class="block text-[10px] uppercase tracking-[0.2em] text-slate-500 mb-2 font-bold ml-1"
            >Transit Yeri</label
          >
          <div class="relative">
            <input
              type="text"
              id="transit_location_search"
              name="transit_location_search"
              autocomplete="off"
              placeholder="Konum Ara..."
              class="w-full px-5 py-4 bg-white/5 border border-white/10 text-sm text-white focus:ring-1 focus:ring-accent/50 focus:border-accent/50 transition-all rounded-2xl outline-none hover:bg-white/10 pl-12"
            />
            <span
              class="material-icons-round absolute left-4 top-1/2 -translate-y-1/2 text-slate-500 text-lg"
              >public</span
            >
            <div
              id="transit_location_suggestions"
              class="location-suggestions hidden"
            ></div>
          </div>
        </div>
      </div>

      <!-- Submit Button -->
      <button
        type="submit"
        class="w-full group relative mt-8 py-5 px-6 bg-primary hover:bg-violet-600 text-white font-bold font-display tracking-[0.2em] uppercase text-xs transition-all duration-500 rounded-2xl shadow-[0_0_30px_rgba(91,43,238,0.3)] overflow-hidden active:scale-[0.98]"
      >
        <div
          class="absolute inset-0 bg-gradient-to-r from-white/0 via-white/10 to-white/0 -translate-x-full group-hover:translate-x-full transition-transform duration-1000"
        ></div>
        <span class="relative flex items-center justify-center gap-3">
          ANALİZİ BAŞLAT
          <span class="material-icons-round text-lg animate-pulse"
            >auto_awesome</span
          >
        </span>
      </button>
    </form>
  </div>

  <!-- Privacy Note -->
  <div
    class="mt-8 flex items-start gap-4 p-5 rounded-3xl border border-white/5 bg-white/[0.02] max-w-sm backdrop-blur-sm relative z-10 transition-opacity hover:opacity-100 opacity-60"
  >
    <span class="material-icons-round text-slate-500 text-xl flex-shrink-0"
      >shield</span
    >
    <div class="text-[10px] leading-relaxed text-slate-400 font-light">
      <strong
        class="text-slate-200 font-bold block mb-1 uppercase tracking-widest"
        >Kozmik Güvenlik</strong
      >
      Verileriniz tarayıcınızda şifrelenir. Analiz süreci tamamlandıktan sonra
      bulut üzerinden temizlenir.
    </div>
  </div>
</div>

<!-- Loading Overlay -->
<div
  id="loadingOverlay"
  class="fixed inset-0 bg-background-dark/95 backdrop-blur-3xl z-[100] hidden flex flex-col items-center justify-center transition-all duration-500"
>
  <div class="relative w-64 h-64 mb-10 flex items-center justify-center">
    <div
      class="absolute inset-0 border-[0.5px] border-white/10 rounded-full animate-spin-slow"
    ></div>
    <div
      class="absolute inset-8 border-[0.5px] border-primary/20 rounded-full animate-spin-reverse-slow"
    ></div>
    <div
      class="w-16 h-16 rounded-full border border-primary/40 flex items-center justify-center animate-breathe"
    >
      <span class="material-icons-round text-primary text-3xl animate-pulse"
        >all_inclusive</span
      >
    </div>
  </div>
  <div class="text-center space-y-4">
    <h3
      class="text-2xl font-display font-bold tracking-widest text-white uppercase"
    >
      Hesaplanıyor
    </h3>
    <p
      id="loading-message"
      class="text-xs text-slate-400 font-light tracking-[0.2em] animate-pulse"
    >
      Yıldızların konumu taranıyor...
    </p>
  </div>
</div>

<!-- Copyright Footer -->
<footer class="mt-8 pb-6 text-center px-4">
  <!-- Sorumluluk Reddi -->
  <div
    class="max-w-md mx-auto mb-4 p-3 rounded-xl bg-slate-800/30 border border-slate-700/30"
  >
    <p class="text-[9px] text-slate-500 leading-relaxed">
      <span class="text-amber-500/70">⚠️</span>
      Bu uygulama yalnızca eğlence ve kişisel keşif amaçlıdır. Sunulan
      astrolojik yorumlar, yapay zeka tarafından üretilmiş genel bilgilerdir ve
      profesyonel danışmanlık niteliği taşımaz.
    </p>
  </div>

  <p class="text-[10px] text-slate-600">© 2025 ORBIS Astrology</p>
  <p class="text-[9px] text-slate-700 mt-1">by Erkan ERDEM</p>
  <div class="flex items-center justify-center gap-3 mt-2">
    <a
      href="{{ url_for('legal.terms_of_service') }}"
      class="text-[8px] text-slate-600 hover:text-slate-400 transition-colors"
      >Kullanım Koşulları</a
    >
    <span class="text-slate-700">•</span>
    <a
      href="{{ url_for('legal.privacy_policy') }}"
      class="text-[8px] text-slate-600 hover:text-slate-400 transition-colors"
      >Gizlilik Politikası</a
    >
  </div>
</footer>

{% endblock %} {% block scripts %}
<script>
  const OPENCAGE_API_KEY = "{{ opencage_key }}";

  const loadingMessages = [
    "Yıldızların konumu taranıyor...",
    "Kozmik geometri hesaplanıyor...",
    "Yapay zeka verileri sentezliyor...",
    "Kaderin desenleri eşleştiriliyor...",
  ];

  document.addEventListener("DOMContentLoaded", function () {
    // Load saved data
    const savedData = localStorage.getItem("astro_user_data");
    if (savedData) {
      try {
        const data = JSON.parse(savedData);
        if (data.name) document.getElementById("name").value = data.name;
        if (data.birth_date)
          document.getElementById("birth_date").value = data.birth_date;
        if (data.birth_time)
          document.getElementById("birth_time").value = data.birth_time;
        if (data.birth_place_suggestion)
          document.getElementById("suggestionInput").value =
            data.birth_place_suggestion;
        if (data.latitude)
          document.getElementById("latitude").value = data.latitude;
        if (data.longitude)
          document.getElementById("longitude").value = data.longitude;
      } catch (e) {
        console.error("Error loading stored info", e);
      }
    }

    // Form Submission Logic with Ad Control
    const orbisForm = document.getElementById("orbisForm");
    orbisForm.addEventListener("submit", function (e) {
      e.preventDefault(); // Önce formu durdur

      // Reklam kontrolü yap
      if (window.OrbisBridge) {
        window.OrbisBridge.requestAnalysis(
          // Başarılı - reklam izlendi veya premium
          function () {
            submitForm();
          },
          // İptal edildi
          function () {
            console.log("[ORBIS] Analiz iptal edildi");
          }
        );
      } else {
        // Bridge yoksa direkt submit
        submitForm();
      }
    });

    function submitForm() {
      $("#loadingOverlay").removeClass("hidden").addClass("flex");
      let msgIdx = 0;
      const msgInterval = setInterval(() => {
        msgIdx = (msgIdx + 1) % loadingMessages.length;
        $("#loading-message").fadeOut(400, function () {
          $(this).text(loadingMessages[msgIdx]).fadeIn(400);
        });
      }, 2500);

      const formData = {
        name: document.getElementById("name").value,
        birth_date: document.getElementById("birth_date").value,
        birth_time: document.getElementById("birth_time").value,
        birth_place_suggestion:
          document.getElementById("suggestionInput").value,
        latitude: document.getElementById("latitude").value,
        longitude: document.getElementById("longitude").value,
      };
      localStorage.setItem("astro_user_data", JSON.stringify(formData));

      // Formu gönder
      document.getElementById("orbisForm").submit();
    }

    // Location Autocomplete
    setupLocationSearch(
      "suggestionInput",
      "suggestionResults",
      "latitude",
      "longitude"
    );
    setupLocationSearch(
      "transit_location_search",
      "transit_location_suggestions",
      "transit_latitude",
      "transit_longitude"
    );

    function setupLocationSearch(inputId, resultsId, latId, lngId) {
      const $input = $("#" + inputId);
      const $results = $("#" + resultsId);

      $input.on("input", function () {
        const query = $(this).val().trim();
        if (query.length >= 3) {
          const url = `https://api.opencagedata.com/geocode/v1/json?q=${encodeURIComponent(
            query
          )}&key=${OPENCAGE_API_KEY}&limit=5&language=tr`;
          fetch(url)
            .then((res) => res.json())
            .then((data) => {
              $results.empty().removeClass("hidden");
              if (data.results && data.results.length > 0) {
                data.results.forEach((res) => {
                  const $item = $(
                    '<div class="location-suggestion-item"></div>'
                  )
                    .text(res.formatted)
                    .on("click", function () {
                      $input.val(res.formatted);
                      $("#" + latId).val(res.geometry.lat);
                      $("#" + lngId).val(res.geometry.lng);
                      $results.addClass("hidden");
                    });
                  $results.append($item);
                });
              } else {
                $results.addClass("hidden");
              }
            });
        } else {
          $results.addClass("hidden");
        }
      });

      $(document).on("click", function (e) {
        if (!$(e.target).closest(".group").length) {
          $results.addClass("hidden");
        }
      });
    }
  });
</script>
{% endblock %}
