{% extends "admin/layout.html" %} {% block title %}ORBIS Admin - İstatistikler{%
endblock %} {% block page_title %}İstatistikler{% endblock %} {% block
page_subtitle %}Detaylı analiz ve raporlar{% endblock %} {% block content %}
<!-- Overview Stats -->
<div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
  <div class="stat-card rounded-2xl p-5">
    <div class="flex items-center gap-3 mb-3">
      <span class="material-icons-round text-primary">people</span>
      <span class="text-xs text-slate-500 uppercase tracking-wider"
        >Toplam Kullanıcı</span
      >
    </div>
    <div class="text-3xl font-bold" id="stat-total">-</div>
  </div>

  <div class="stat-card rounded-2xl p-5">
    <div class="flex items-center gap-3 mb-3">
      <span class="material-icons-round text-yellow-400">diamond</span>
      <span class="text-xs text-slate-500 uppercase tracking-wider"
        >Premium</span
      >
    </div>
    <div class="text-3xl font-bold" id="stat-premium">-</div>
  </div>

  <div class="stat-card rounded-2xl p-5">
    <div class="flex items-center gap-3 mb-3">
      <span class="material-icons-round text-green-400">trending_up</span>
      <span class="text-xs text-slate-500 uppercase tracking-wider"
        >Bugün Aktif</span
      >
    </div>
    <div class="text-3xl font-bold" id="stat-active">-</div>
  </div>

  <div class="stat-card rounded-2xl p-5">
    <div class="flex items-center gap-3 mb-3">
      <span class="material-icons-round text-accent">auto_awesome</span>
      <span class="text-xs text-slate-500 uppercase tracking-wider"
        >Toplam Analiz</span
      >
    </div>
    <div class="text-3xl font-bold" id="stat-analyses">-</div>
  </div>
</div>

<div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
  <!-- User Distribution -->
  <div class="glass-card rounded-2xl p-6">
    <h3 class="font-display font-bold text-lg mb-6 flex items-center gap-2">
      <span class="material-icons-round text-primary">pie_chart</span>
      Kullanıcı Dağılımı
    </h3>

    <div class="flex items-center justify-center py-8">
      <div class="relative w-48 h-48">
        <svg class="w-full h-full transform -rotate-90">
          <circle
            cx="96"
            cy="96"
            r="80"
            stroke="currentColor"
            stroke-width="20"
            fill="none"
            class="text-slate-700"
          />
          <circle
            id="dist-premium-circle"
            cx="96"
            cy="96"
            r="80"
            stroke="currentColor"
            stroke-width="20"
            fill="none"
            class="text-yellow-400"
            stroke-dasharray="502"
            stroke-dashoffset="502"
            stroke-linecap="round"
            style="transition: stroke-dashoffset 1s ease"
          />
        </svg>
        <div class="absolute inset-0 flex flex-col items-center justify-center">
          <span id="dist-premium-percent" class="text-4xl font-bold">0%</span>
          <span class="text-xs text-slate-500">Premium Oranı</span>
        </div>
      </div>
    </div>

    <div class="flex justify-center gap-8 mt-4">
      <div class="flex items-center gap-2">
        <div class="w-4 h-4 rounded-full bg-yellow-400"></div>
        <div>
          <span class="text-sm font-medium" id="dist-premium-count">0</span>
          <span class="text-xs text-slate-500 ml-1">Premium</span>
        </div>
      </div>
      <div class="flex items-center gap-2">
        <div class="w-4 h-4 rounded-full bg-slate-600"></div>
        <div>
          <span class="text-sm font-medium" id="dist-free-count">0</span>
          <span class="text-xs text-slate-500 ml-1">Ücretsiz</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Purchase Stats -->
  <div class="glass-card rounded-2xl p-6">
    <h3 class="font-display font-bold text-lg mb-6 flex items-center gap-2">
      <span class="material-icons-round text-primary">shopping_cart</span>
      Son 30 Gün Satışlar
    </h3>

    <div class="grid grid-cols-2 gap-4 mb-6">
      <div class="p-4 bg-yellow-500/10 border border-yellow-500/20 rounded-xl">
        <div class="flex items-center gap-2 mb-2">
          <span class="material-icons-round text-yellow-400 text-lg"
            >diamond</span
          >
          <span class="text-xs text-slate-500">Premium Satış</span>
        </div>
        <div class="text-2xl font-bold" id="purchase-premium">-</div>
      </div>

      <div class="p-4 bg-primary/10 border border-primary/20 rounded-xl">
        <div class="flex items-center gap-2 mb-2">
          <span class="material-icons-round text-primary text-lg">toll</span>
          <span class="text-xs text-slate-500">Kredi Satış</span>
        </div>
        <div class="text-2xl font-bold" id="purchase-credits">-</div>
      </div>
    </div>

    <div class="p-4 bg-white/5 rounded-xl">
      <div class="flex items-center justify-between mb-2">
        <span class="text-sm text-slate-400">Toplam Satılan Kredi</span>
        <span class="material-icons-round text-green-400 text-lg"
          >trending_up</span
        >
      </div>
      <div
        class="text-3xl font-bold text-green-400"
        id="purchase-total-credits"
      >
        -
      </div>
    </div>
  </div>

  <!-- Credit Distribution -->
  <div class="glass-card rounded-2xl p-6">
    <h3 class="font-display font-bold text-lg mb-6 flex items-center gap-2">
      <span class="material-icons-round text-primary"
        >account_balance_wallet</span
      >
      Kredi Dağılımı
    </h3>

    <div class="space-y-4">
      <div class="flex items-center justify-between p-4 bg-white/5 rounded-xl">
        <span class="text-sm">Toplam Kredi (Sistemde)</span>
        <span class="text-xl font-bold" id="credit-total">-</span>
      </div>

      <div class="flex items-center justify-between p-4 bg-white/5 rounded-xl">
        <span class="text-sm">Ortalama Kredi/Kullanıcı</span>
        <span class="text-xl font-bold" id="credit-avg">-</span>
      </div>

      <div class="flex items-center justify-between p-4 bg-white/5 rounded-xl">
        <span class="text-sm">Ortalama Analiz/Kullanıcı</span>
        <span class="text-xl font-bold" id="analysis-avg">-</span>
      </div>
    </div>
  </div>

  <!-- Conversion Metrics -->
  <div class="glass-card rounded-2xl p-6">
    <h3 class="font-display font-bold text-lg mb-6 flex items-center gap-2">
      <span class="material-icons-round text-primary">swap_vert</span>
      Dönüşüm Metrikleri
    </h3>

    <div class="space-y-4">
      <!-- Premium Conversion -->
      <div>
        <div class="flex items-center justify-between mb-2">
          <span class="text-sm text-slate-400">Premium Dönüşüm Oranı</span>
          <span class="text-sm font-bold" id="conv-premium">-%</span>
        </div>
        <div class="h-2 bg-slate-700 rounded-full overflow-hidden">
          <div
            id="conv-premium-bar"
            class="h-full bg-yellow-400 rounded-full transition-all duration-1000"
            style="width: 0%"
          ></div>
        </div>
      </div>

      <!-- Active Rate -->
      <div>
        <div class="flex items-center justify-between mb-2">
          <span class="text-sm text-slate-400">Günlük Aktif Oran</span>
          <span class="text-sm font-bold" id="conv-active">-%</span>
        </div>
        <div class="h-2 bg-slate-700 rounded-full overflow-hidden">
          <div
            id="conv-active-bar"
            class="h-full bg-green-400 rounded-full transition-all duration-1000"
            style="width: 0%"
          ></div>
        </div>
      </div>

      <!-- Engagement -->
      <div>
        <div class="flex items-center justify-between mb-2">
          <span class="text-sm text-slate-400"
            >Analiz Yapan Kullanıcı Oranı</span
          >
          <span class="text-sm font-bold" id="conv-engaged">-%</span>
        </div>
        <div class="h-2 bg-slate-700 rounded-full overflow-hidden">
          <div
            id="conv-engaged-bar"
            class="h-full bg-accent rounded-full transition-all duration-1000"
            style="width: 0%"
          ></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Export Section -->
<div class="glass-card rounded-2xl p-6 mt-6">
  <div class="flex items-center justify-between">
    <div>
      <h3 class="font-display font-bold text-lg flex items-center gap-2">
        <span class="material-icons-round text-primary">download</span>
        Veri Dışa Aktarma
      </h3>
      <p class="text-sm text-slate-500 mt-1">
        İstatistikleri CSV formatında indirin
      </p>
    </div>

    <div class="flex gap-3">
      <button
        onclick="exportData('users')"
        class="flex items-center gap-2 px-4 py-2 bg-white/5 hover:bg-white/10 rounded-xl text-sm transition-colors"
      >
        <span class="material-icons-round text-lg">people</span>
        Kullanıcılar
      </button>
      <button
        onclick="exportData('purchases')"
        class="flex items-center gap-2 px-4 py-2 bg-white/5 hover:bg-white/10 rounded-xl text-sm transition-colors"
      >
        <span class="material-icons-round text-lg">receipt</span>
        Satışlar
      </button>
    </div>
  </div>
</div>
{% endblock %} {% block scripts %}
<script>
  async function loadStats() {
    try {
      // Overview stats
      const overviewRes = await fetch("/admin/api/stats/overview");
      const overviewData = await overviewRes.json();

      if (overviewData.success) {
        const stats = overviewData.data;

        // Basic stats
        document.getElementById("stat-total").textContent = formatNumber(
          stats.totalUsers
        );
        document.getElementById("stat-premium").textContent = formatNumber(
          stats.premiumUsers
        );
        document.getElementById("stat-active").textContent = formatNumber(
          stats.activeToday
        );
        document.getElementById("stat-analyses").textContent = formatNumber(
          stats.totalAnalyses
        );

        // Distribution
        const premiumPercent =
          stats.totalUsers > 0
            ? (stats.premiumUsers / stats.totalUsers) * 100
            : 0;
        document.getElementById("dist-premium-percent").textContent =
          premiumPercent.toFixed(1) + "%";
        document.getElementById("dist-premium-count").textContent =
          stats.premiumUsers;
        document.getElementById("dist-free-count").textContent =
          stats.freeUsers;

        // Update circle
        const circumference = 2 * Math.PI * 80;
        const offset = circumference - (premiumPercent / 100) * circumference;
        document.getElementById("dist-premium-circle").style.strokeDashoffset =
          offset;

        // Credits
        document.getElementById("credit-total").textContent = formatNumber(
          stats.totalCredits
        );
        const avgCredits =
          stats.totalUsers > 0
            ? (stats.totalCredits / stats.totalUsers).toFixed(1)
            : 0;
        const avgAnalyses =
          stats.totalUsers > 0
            ? (stats.totalAnalyses / stats.totalUsers).toFixed(1)
            : 0;
        document.getElementById("credit-avg").textContent = avgCredits;
        document.getElementById("analysis-avg").textContent = avgAnalyses;

        // Conversion metrics
        document.getElementById("conv-premium").textContent =
          premiumPercent.toFixed(1) + "%";
        document.getElementById("conv-premium-bar").style.width =
          premiumPercent + "%";

        const activePercent =
          stats.totalUsers > 0
            ? (stats.activeToday / stats.totalUsers) * 100
            : 0;
        document.getElementById("conv-active").textContent =
          activePercent.toFixed(1) + "%";
        document.getElementById("conv-active-bar").style.width =
          Math.min(activePercent, 100) + "%";

        // Assume users with analyses > 0 are engaged
        const engagedPercent =
          stats.totalUsers > 0
            ? Math.min((stats.totalAnalyses / stats.totalUsers / 5) * 100, 100)
            : 0;
        document.getElementById("conv-engaged").textContent =
          engagedPercent.toFixed(1) + "%";
        document.getElementById("conv-engaged-bar").style.width =
          engagedPercent + "%";
      }

      // Purchase stats
      const purchaseRes = await fetch("/admin/api/stats/purchases");
      const purchaseData = await purchaseRes.json();

      if (purchaseData.success) {
        const purchases = purchaseData.data.last30Days;
        document.getElementById("purchase-premium").textContent =
          purchases.premiumPurchases;
        document.getElementById("purchase-credits").textContent =
          purchases.creditPurchases;
        document.getElementById("purchase-total-credits").textContent =
          formatNumber(purchases.totalCreditsSold);
      }
    } catch (error) {
      console.error("Stats error:", error);
      showToast("İstatistikler yüklenirken hata oluştu", "error");
    }
  }

  function exportData(type) {
    showToast(`${type} verisi hazırlanıyor...`, "info");
    // TODO: Implement CSV export
    setTimeout(() => {
      showToast("Bu özellik yakında eklenecek", "info");
    }, 1000);
  }

  document.addEventListener("DOMContentLoaded", loadStats);
</script>
{% endblock %}
