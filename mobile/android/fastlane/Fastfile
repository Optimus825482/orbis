# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ORBIS - Fastlane Configuration
# Kaderin Geometrisi - Android Beta & Release Deployment
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

default_platform(:android)

platform :android do

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # BETA DEPLOYMENT
  # Google Play Store Beta (Internal Testing / Closed Testing)
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  desc "Build ve Beta track'e yÃ¼kle (Internal Testing)"
  lane :beta do
    # Version bilgisini gÃ¶ster
    UI.message("ğŸš€ ORBIS Beta Build baÅŸlatÄ±lÄ±yor...")

    # AAB (Android App Bundle) oluÅŸtur - Play Store AAB istiyor
    gradle(
      task: "bundle",
      build_type: "Release",
      project_dir: "./"
    )

    # Google Play Store Beta track'e yÃ¼kle
    upload_to_play_store(
      track: "internal",                    # internal / alpha / beta / production
      aab: "app/build/outputs/bundle/release/app-release.aab",
      skip_upload_metadata: true,
      skip_upload_images: true,
      skip_upload_screenshots: true,
      skip_upload_apk: true,                # AAB yÃ¼klÃ¼yoruz, APK deÄŸil
      release_status: "draft"               # draft / completed
    )

    UI.success("âœ… ORBIS Beta baÅŸarÄ±yla Play Store Internal Testing'e yÃ¼klendi!")
  end

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # BETA APK - Sadece APK oluÅŸtur (Play Store'a yÃ¼klemeden)
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  desc "Sadece Release APK oluÅŸtur (daÄŸÄ±tÄ±m iÃ§in)"
  lane :build_apk do
    UI.message("ğŸ“¦ ORBIS Release APK oluÅŸturuluyor...")

    gradle(
      task: "assemble",
      build_type: "Release",
      project_dir: "./"
    )

    apk_path = Actions.lane_context[SharedValues::GRADLE_APK_OUTPUT_PATH]
    UI.success("âœ… APK hazÄ±r: #{apk_path}")
  end

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # BETA AAB - Sadece AAB oluÅŸtur
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  desc "Sadece Release AAB oluÅŸtur"
  lane :build_aab do
    UI.message("ğŸ“¦ ORBIS Release AAB oluÅŸturuluyor...")

    gradle(
      task: "bundle",
      build_type: "Release",
      project_dir: "./"
    )

    aab_path = Actions.lane_context[SharedValues::GRADLE_AAB_OUTPUT_PATH]
    UI.success("âœ… AAB hazÄ±r: #{aab_path}")
  end

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # CLOSED BETA (Alpha Track)
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  desc "Closed Beta (Alpha track) yÃ¼kle"
  lane :alpha do
    UI.message("ğŸ”’ ORBIS Closed Alpha Build baÅŸlatÄ±lÄ±yor...")

    gradle(
      task: "bundle",
      build_type: "Release",
      project_dir: "./"
    )

    upload_to_play_store(
      track: "alpha",
      aab: "app/build/outputs/bundle/release/app-release.aab",
      skip_upload_metadata: true,
      skip_upload_images: true,
      skip_upload_screenshots: true,
      skip_upload_apk: true,
      release_status: "draft"
    )

    UI.success("âœ… ORBIS Alpha track'e yÃ¼klendi!")
  end

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # OPEN BETA
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  desc "Open Beta track'e yÃ¼kle"
  lane :open_beta do
    UI.message("ğŸŒ ORBIS Open Beta Build baÅŸlatÄ±lÄ±yor...")

    gradle(
      task: "bundle",
      build_type: "Release",
      project_dir: "./"
    )

    upload_to_play_store(
      track: "beta",
      aab: "app/build/outputs/bundle/release/app-release.aab",
      skip_upload_metadata: true,
      skip_upload_images: true,
      skip_upload_screenshots: true,
      skip_upload_apk: true,
      release_status: "completed"
    )

    UI.success("âœ… ORBIS Open Beta'ya yÃ¼klendi!")
  end

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # PRODUCTION RELEASE
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  desc "Production'a yÃ¼kle (DÄ°KKAT: CanlÄ±ya Ã§Ä±kar!)"
  lane :release do
    UI.message("ğŸš€ ORBIS Production Release baÅŸlatÄ±lÄ±yor...")
    UI.important("âš ï¸  Bu iÅŸlem uygulamayÄ± canlÄ±ya Ã§Ä±karacak!")

    gradle(
      task: "bundle",
      build_type: "Release",
      project_dir: "./"
    )

    upload_to_play_store(
      track: "production",
      aab: "app/build/outputs/bundle/release/app-release.aab",
      skip_upload_apk: true,
      release_status: "completed"
    )

    UI.success("âœ… ORBIS Production'a yÃ¼klendi!")
  end

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # BETA'DAN PRODUCTION'A PROMOTE ET
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  desc "Beta'daki build'i Production'a promote et"
  lane :promote_to_production do
    UI.message("â¬†ï¸  Beta build Production'a promote ediliyor...")

    upload_to_play_store(
      track: "internal",
      track_promote_to: "production",
      skip_upload_aab: true,
      skip_upload_apk: true,
      skip_upload_metadata: true,
      skip_upload_images: true,
      skip_upload_screenshots: true
    )

    UI.success("âœ… Beta build Production'a promote edildi!")
  end

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # METADATA SYNC
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  desc "Play Store metadata'sÄ±nÄ± indir"
  lane :sync_metadata do
    UI.message("ğŸ“¥ Play Store metadata indiriliyor...")
    download_from_play_store
    UI.success("âœ… Metadata indirildi: fastlane/metadata/android/")
  end

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # VERSION BUMP
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  desc "Version code'u artÄ±r"
  lane :bump_version do |options|
    # build.gradle'dan mevcut version'Ä± oku
    build_gradle = File.read("../app/build.gradle")
    current_version_code = build_gradle.match(/versionCode\s*=\s*(\d+)/)[1].to_i
    current_version_name = build_gradle.match(/versionName\s*=\s*"([^"]+)"/)[1]

    new_version_code = current_version_code + 1

    # Version name bump (patch)
    version_parts = current_version_name.split(".")
    version_parts[2] = (version_parts[2].to_i + 1).to_s
    new_version_name = version_parts.join(".")

    # build.gradle gÃ¼ncelle
    updated_gradle = build_gradle
      .gsub(/versionCode\s*=\s*\d+/, "versionCode = #{new_version_code}")
      .gsub(/versionName\s*=\s*"[^"]+"/, "versionName = \"#{new_version_name}\"")

    File.write("../app/build.gradle", updated_gradle)

    UI.success("âœ… Version gÃ¼ncellendi: #{current_version_name} (#{current_version_code}) â†’ #{new_version_name} (#{new_version_code})")
  end

end
